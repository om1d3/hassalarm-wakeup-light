# Hassalarm wake-up light integration
# complete configuration.yaml example
# 
# copy the sections you need into your existing configuration.yaml
# DO NOT replace your entire file with this!

# ========================================
# INPUT DATETIME
# stores the next alarm time from Hassalarm app
# ========================================
input_datetime:
  next_alarm:
    name: Next scheduled alarm
    has_date: true
    has_time: true

# ========================================
# INPUT BOOLEAN
# toggle to enable/disable the alarm light automation
# ========================================
input_boolean:
  alarm_light_enabled:
    name: Alarm Light Enabled
    initial: true  # set to false if you want it disabled by default
    icon: mdi:lightbulb-alert

# ========================================
# TIME SENSOR
# required for automation trigger
# ========================================
sensor:
  - platform: time_date
    display_options:
      - 'date_time'
      # You can also add these if needed:
      # - 'time'
      # - 'date'
      # - 'time_date'
      # - 'time_utc'
      # - 'beat'

# ========================================
# HISTORY & RECORDER (Optional but Recommended)
# preserves alarm time across Home Assistant restarts
# ========================================
history:
  # basic configuration - stores all entities
  # you can customize to include/exclude specific entities

recorder:
  # basic configuration - default database settings
  # adjust purge_keep_days if you want to keep data longer/shorter
  purge_keep_days: 7
  
  # optional: only record specific entities to save space
  # include:
  #   entities:
  #     - input_datetime.next_alarm
  #     - input_boolean.alarm_light_enabled
  #     - device_tracker.your_phone

# ========================================
# OPTIONAL: TEMPLATE SENSOR
# shows time remaining until alarm
# ========================================
template:
  - sensor:
      - name: "time until alarm"
        unique_id: time_until_alarm
        state: >
          {% set alarm = states('input_datetime.next_alarm') %}
          {% if alarm not in ['unknown', 'unavailable'] %}
            {% set alarm_time = state_attr('input_datetime.next_alarm', 'timestamp') | int %}
            {% set now_time = now().timestamp() | int %}
            {% set diff = alarm_time - now_time %}
            {% if diff > 0 %}
              {{ (diff // 3600) }}h {{ ((diff % 3600) // 60) }}m
            {% else %}
              No upcoming alarm
            {% endif %}
          {% else %}
            No alarm set
          {% endif %}
        icon: mdi:timer
        
      - name: "next Alarm friendly"
        unique_id: next_alarm_friendly
        state: >
          {% set alarm = states('input_datetime.next_alarm') %}
          {% if alarm not in ['unknown', 'unavailable'] %}
            {{ as_timestamp(alarm) | timestamp_custom('%A, %B %d at %I:%M %p') }}
          {% else %}
            No alarm scheduled
          {% endif %}
        icon: mdi:alarm

# ========================================
# OPTIONAL: NOTIFICATIONS
# get notified when alarm is set
# ========================================
# automation:
#   - alias: "notify when Alarm set"
#     trigger:
#       - platform: state
#         entity_id: input_datetime.next_alarm
#     condition:
#       - condition: template
#         value_template: "{{ trigger.to_state.state not in ['unknown', 'unavailable'] }}"
#     action:
#       - service: notify.mobile_app_your_phone
#         data:
#           title: "Alarm set"
#           message: "wake up light will trigger at {{ states('sensor.next_alarm_friendly') }}"
